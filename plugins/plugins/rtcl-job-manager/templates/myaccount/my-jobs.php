<?php
/**
 * Manage Listing by user
 *
 * @author        RadiusTheme
 * @package       classified-listing/templates
 * @version       1.0.0
 *
 * @var WP_Query $rtcl_query
 */


use Rtcl\Helpers\Functions;
use Rtcl\Helpers\Link;
use Rtcl\Helpers\Pagination;

global $post;

?>

<div class="rtcl-manage-my-listings">
    <div class="rtcl-MyAccount-content-inner">
		<?php
		if ( isset( $no_application ) ) {
			// echo esc_html__('No Application Found', 'rtcl-job-manager');
			?>
            <p class="rtcl-no-data-found"><?php esc_html_e( 'No Application found.', 'rtcl-job-manager' ); ?></p>
			<?php
		} else {


			?>

			<?php if ( $rtcl_query->have_posts() ) : ?>

                <table class="rtcl-my-listing-table">
                    <thead>
                    <tr>
                        <th><?php esc_html_e( 'Thumbnail', 'classified-listing' ); ?></th>
                        <th class="title-cell list-on-responsive"><?php esc_html_e( 'Title', 'rtcl-job-manager' ); ?></th>
                        <th style="width: 300px" class="list-on-responsive"><?php esc_html_e( 'Informations', 'rtcl-job-manager' ); ?></th>
                        <th class="list-on-responsive"><?php esc_html_e( 'Status', 'rtcl-job-manager' ); ?></th>
                    </tr>
                    </thead>
                    <tbody>
					<?php
					while ( $rtcl_query->have_posts() ) :
						$rtcl_query->the_post();

						$app_id = $applications[ $post->ID ];

						global $wpdb;

						$table_name = $wpdb->prefix . 'rtcl_job_applications';

						// * - created_at, job_status
						$query       = "SELECT * FROM $table_name WHERE id='%d'";
						$prepareData = $wpdb->prepare( $query, $app_id );
						$result      = $wpdb->get_row( $prepareData, ARRAY_A );
						$created_at  = $result['created_at'] ?? '';
						$job_status  = $result['status'] ?? '';

						$post_meta  = get_post_meta( $post->ID );
						$listing    = rtcl()->factory->get_listing( $post->ID );
						$is_top     = (bool) get_post_meta( $listing->get_id(), '_top', true );
						$is_bump_up = (bool) get_post_meta( $listing->get_id(), '_bump_up', true );
						?>
                        <tr>
                            <td>
                                <div class="listing-thumb">
                                    <a href="<?php the_permalink(); ?>"><?php $listing->the_thumbnail(); ?></a>
									<?php do_action( 'rtcl_my_listing_after_listing_thumb', $listing ); ?>
                                </div>
                            </td>
                            <td class="title-cell">
                                <div class="rtcl-ad-details">
                                    <a class="listing-title" href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
									<?php
									$expiry_date = $post_meta['expiry_date'] ?? '';
									?>
                                    <ul class="rtcl-meta">
                                        <li>
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                 xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd"
                                                      d="M7.99941 1.60002C4.46479 1.60002 1.59941 4.4654 1.59941 8.00002C1.59941 11.5346 4.46479 14.4 7.99941 14.4C11.534 14.4 14.3994 11.5346 14.3994 8.00002C14.3994 4.4654 11.534 1.60002 7.99941 1.60002ZM0.399414 8.00002C0.399414 3.80266 3.80205 0.400024 7.99941 0.400024C12.1968 0.400024 15.5994 3.80266 15.5994 8.00002C15.5994 12.1974 12.1968 15.6 7.99941 15.6C3.80205 15.6 0.399414 12.1974 0.399414 8.00002ZM7.99941 3.20002C8.33078 3.20002 8.59941 3.46865 8.59941 3.80002V7.6292L11.0677 8.86337C11.3641 9.01156 11.4843 9.37196 11.3361 9.66835C11.1879 9.96474 10.8275 10.0848 10.5311 9.93668L7.73108 8.53668C7.52781 8.43505 7.39941 8.22729 7.39941 8.00002V3.80002C7.39941 3.46865 7.66804 3.20002 7.99941 3.20002Z"
                                                      fill="currentColor"/>
                                            </svg>
											<?php $listing->the_time(); ?>
                                        </li>
										<?php if ( $listing->has_category() ) : ?>
                                            <li>
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                     xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                                          d="M0.399414 1.00002C0.399414 0.668653 0.668044 0.400024 0.999414 0.400024H8.30189C8.46104 0.400024 8.61368 0.46326 8.72621 0.575815L15.0003 6.85154C15.384 7.23769 15.5994 7.76 15.5994 8.30441C15.5994 8.84881 15.384 9.37113 15.0003 9.75727L14.999 9.75853L9.76339 14.9955C9.57204 15.1871 9.34479 15.3392 9.09464 15.4429C8.84448 15.5466 8.57634 15.6 8.30554 15.6C8.03474 15.6 7.76659 15.5466 7.51644 15.4429C7.26649 15.3392 7.03941 15.1874 6.84815 14.996C6.8483 14.9961 6.84799 14.9958 6.84815 14.996L0.575342 8.72886C0.462703 8.61633 0.399414 8.46363 0.399414 8.30441V1.00002ZM1.59941 1.60002V8.05572L7.69631 14.1471C7.77623 14.2271 7.87162 14.2911 7.97607 14.3344C8.08052 14.3777 8.19247 14.4 8.30554 14.4C8.4186 14.4 8.53056 14.3777 8.635 14.3344C8.73945 14.2911 8.83436 14.2276 8.91428 14.1476L14.1491 8.91138C14.1493 8.91119 14.1489 8.91157 14.1491 8.91138C14.309 8.75015 14.3994 8.53162 14.3994 8.30441C14.3994 8.0772 14.3096 7.85924 14.1497 7.69801C14.1499 7.6982 14.1495 7.69782 14.1497 7.69801L8.05331 1.60002H1.59941ZM4.05065 4.65222C4.05065 4.32084 4.31928 4.05222 4.65065 4.05222H4.65795C4.98932 4.05222 5.25795 4.32084 5.25795 4.65222C5.25795 4.98359 4.98932 5.25222 4.65795 5.25222H4.65065C4.31928 5.25222 4.05065 4.98359 4.05065 4.65222Z"
                                                          fill="currentColor"/>
                                                </svg>
												<?php $listing->the_categories( true, true ); ?>
                                            </li>
										<?php endif; ?>
										<?php if ( $listing->has_location() ) : ?>
                                            <li>
                                                <svg width="13" height="16" viewBox="0 0 13 16" fill="none"
                                                     xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                                          d="M6.49941 1.60002C5.20787 1.60002 3.96406 2.13406 3.04309 3.09309C2.12132 4.05295 1.59941 5.3598 1.59941 6.7273C1.59941 8.7224 2.84381 10.6471 4.19323 12.1303C4.85707 12.86 5.52277 13.4571 6.02302 13.8719C6.20793 14.0253 6.3696 14.1532 6.49941 14.2531C6.62922 14.1532 6.7909 14.0253 6.9758 13.8719C7.47605 13.4571 8.14176 12.86 8.8056 12.1303C10.155 10.6471 11.3994 8.7224 11.3994 6.7273C11.3994 5.3598 10.8775 4.05295 9.95571 3.09309C9.03481 2.13406 7.79095 1.60002 6.49941 1.60002ZM6.49941 15C6.15725 15.4929 6.1571 15.4928 6.15692 15.4926L6.15519 15.4914L6.15114 15.4886L6.13717 15.4788C6.12529 15.4704 6.10835 15.4583 6.08667 15.4427C6.04332 15.4114 5.98101 15.3658 5.90245 15.3068C5.74538 15.1886 5.523 15.0162 5.25705 14.7957C4.72605 14.3554 4.01676 13.7195 3.3056 12.9379C1.90502 11.3984 0.399414 9.18674 0.399414 6.7273C0.399414 5.05686 1.03643 3.4502 2.17756 2.26191C3.31949 1.0728 4.87357 0.400024 6.49941 0.400024C8.12525 0.400024 9.67931 1.0728 10.8213 2.26191C11.9624 3.4502 12.5994 5.05686 12.5994 6.7273C12.5994 9.18674 11.0938 11.3984 9.69321 12.9379C8.98207 13.7195 8.27277 14.3554 7.74177 14.7957C7.47582 15.0162 7.25344 15.1886 7.09637 15.3068C7.01781 15.3658 6.9555 15.4114 6.91215 15.4427C6.89047 15.4583 6.87353 15.4704 6.86166 15.4788L6.84769 15.4886L6.84363 15.4914L6.84235 15.4923C6.84218 15.4924 6.84157 15.4929 6.49941 15ZM6.49941 15L6.84235 15.4923C6.6366 15.6352 6.36267 15.6355 6.15692 15.4926L6.49941 15ZM6.49941 5.41821C5.84093 5.41821 5.26608 5.98118 5.26608 6.7273C5.26608 7.47342 5.84093 8.03639 6.49941 8.03639C7.1579 8.03639 7.73275 7.47342 7.73275 6.7273C7.73275 5.98118 7.1579 5.41821 6.49941 5.41821ZM4.06608 6.7273C4.06608 5.36469 5.13285 4.21821 6.49941 4.21821C7.86597 4.21821 8.93275 5.36469 8.93275 6.7273C8.93275 8.0899 7.86597 9.23639 6.49941 9.23639C5.13285 9.23639 4.06608 8.0899 4.06608 6.7273Z"
                                                          fill="currentColor"/>
                                                </svg>
												<?php $listing->the_locations( true, true ); ?>
                                            </li>
										<?php endif; ?>

										<?php if ( ! empty( $expiry_date[0] ) ) : ?>
                                            <li>
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <g clip-path="url(#clip0_2101_7)">
                                                        <path d="M8.00261 0.665283C3.96103 0.665283 0.665283 3.96103 0.665283 8.00261C0.665283 12.0442 3.96103 15.3349 8.00261 15.3349C9.94643 15.3322 11.8099 14.5589 13.1844 13.1844C14.5589 11.8099 15.3322 9.94643 15.3349 8.00261C15.3352 7.91471 15.3182 7.82761 15.2848 7.74631C15.2514 7.66501 15.2022 7.5911 15.1402 7.52883C15.0782 7.46656 15.0045 7.41715 14.9233 7.38344C14.8421 7.34972 14.7551 7.33237 14.6672 7.33237C14.5795 7.3327 14.4927 7.3503 14.4118 7.38416C14.331 7.41802 14.2575 7.46748 14.1958 7.52972C14.134 7.59196 14.0851 7.66575 14.0518 7.74689C14.0186 7.82803 14.0016 7.91492 14.002 8.00261C14.0036 8.79071 13.8497 9.57138 13.5489 10.2998C13.2482 11.0283 12.8066 11.6902 12.2494 12.2476C11.6922 12.805 11.0305 13.2469 10.3022 13.548C9.57384 13.849 8.79323 14.0033 8.00513 14.002C6.41333 14.002 4.88672 13.3696 3.76115 12.2441C2.63558 11.1185 2.00324 9.59189 2.00324 8.00009C2.00324 6.40829 2.63558 4.88168 3.76115 3.75611C4.88672 2.63054 6.41333 1.9982 8.00513 1.9982C8.18091 1.99687 8.34907 1.92628 8.47313 1.80175C8.59719 1.67722 8.66714 1.50878 8.6678 1.333C8.6678 1.15635 8.5978 0.98689 8.47313 0.861741C8.34845 0.736593 8.17926 0.66595 8.00261 0.665283ZM10.5324 1.1667C10.3768 1.1654 10.2257 1.21868 10.1053 1.31728C9.98491 1.41587 9.90291 1.55355 9.87355 1.70635C9.84419 1.85915 9.86932 2.01741 9.94458 2.1536C10.0198 2.28979 10.1404 2.39528 10.2854 2.45174L10.3056 2.46182C10.3872 2.5011 10.4759 2.52338 10.5664 2.5273C10.6569 2.53122 10.7472 2.51669 10.8319 2.48461C10.9165 2.45252 10.9938 2.40355 11.059 2.34066C11.1241 2.27778 11.1758 2.2023 11.2109 2.11881C11.2459 2.03533 11.2637 1.94558 11.263 1.85503C11.2623 1.76447 11.2432 1.67501 11.2068 1.59208C11.1704 1.50915 11.1176 1.43448 11.0514 1.37261C10.9853 1.31075 10.9073 1.26298 10.8221 1.23221L10.7944 1.21709C10.7114 1.18277 10.6222 1.16563 10.5324 1.1667ZM12.7018 2.60796C12.5697 2.60834 12.4407 2.64789 12.3311 2.7216C12.2215 2.79531 12.1362 2.89987 12.0861 3.02206C12.0359 3.14425 12.0231 3.27857 12.0493 3.40803C12.0755 3.5375 12.1395 3.65629 12.2332 3.74938L12.2483 3.7645C12.3091 3.83057 12.3826 3.8837 12.4644 3.92071C12.5462 3.95772 12.6346 3.97785 12.7244 3.97989C12.8142 3.98194 12.9034 3.96585 12.9869 3.9326C13.0703 3.89936 13.1461 3.84962 13.2099 3.78638C13.2736 3.72315 13.3239 3.6477 13.3579 3.56456C13.3918 3.48142 13.4086 3.39229 13.4073 3.3025C13.4059 3.21272 13.3865 3.12412 13.3502 3.04202C13.3138 2.95991 13.2613 2.88598 13.1957 2.82465L13.1755 2.8045C13.1134 2.74213 13.0396 2.69266 12.9583 2.65894C12.877 2.62521 12.7898 2.60788 12.7018 2.60796ZM8.00261 3.33363C7.91471 3.3333 7.82761 3.35032 7.74631 3.38373C7.66501 3.41714 7.5911 3.46627 7.52883 3.52831C7.46656 3.59034 7.41715 3.66406 7.38344 3.74524C7.34972 3.82641 7.33237 3.91345 7.33237 4.00135V8.00261C7.33297 8.12631 7.36792 8.24741 7.43332 8.35241C7.49872 8.4574 7.592 8.54217 7.70276 8.59725L10.3686 9.93268C10.4473 9.97195 10.533 9.99528 10.6207 10.0013C10.7085 10.0074 10.7966 9.99602 10.8799 9.96792C10.9633 9.93983 11.0403 9.89554 11.1064 9.8376C11.1726 9.77967 11.2267 9.70922 11.2656 9.63032C11.3441 9.47161 11.3564 9.28821 11.2996 9.12047C11.2429 8.95272 11.1219 8.81437 10.9632 8.73583L8.6678 7.58938V4.00135C8.6678 3.82469 8.5978 3.65524 8.47313 3.53009C8.34845 3.40494 8.17926 3.3343 8.00261 3.33363ZM14.1607 4.76733C14.0502 4.76656 13.9411 4.79326 13.8434 4.84504C13.7457 4.89681 13.6624 4.97203 13.601 5.06395C13.5395 5.15587 13.5019 5.26161 13.4914 5.37168C13.4809 5.48175 13.4979 5.5927 13.5409 5.69457C13.5409 5.70213 13.5459 5.70717 13.5484 5.71473C13.5794 5.79904 13.627 5.87625 13.6884 5.94173C13.7499 6.00721 13.8239 6.05963 13.9061 6.09583C13.9883 6.13204 14.0769 6.15129 14.1667 6.15245C14.2565 6.1536 14.3456 6.13663 14.4287 6.10255C14.5118 6.06847 14.5872 6.01797 14.6503 5.95409C14.7134 5.89021 14.763 5.81426 14.7961 5.73077C14.8291 5.64728 14.845 5.55797 14.8428 5.4682C14.8406 5.37842 14.8203 5.29002 14.7831 5.20828C14.7831 5.1982 14.778 5.19064 14.773 5.18308C14.7233 5.06113 14.6387 4.95659 14.5297 4.88261C14.4208 4.80864 14.2924 4.76853 14.1607 4.76733Z"
                                                              fill="currentColor"/>
                                                    </g>
                                                    <defs>
                                                        <clipPath id="clip0_2101_7">
                                                            <rect width="16" height="16" fill="white"/>
                                                        </clipPath>
                                                    </defs>
                                                </svg>
                                                <strong><?php echo esc_html__( 'Expire', 'rtcl-job-manager' ); ?>: </strong>
												<?php echo date_i18n( get_option( 'date_format' ), $expiry_date[0] ); ?>
                                            </li>
										<?php endif; ?>
                                    </ul>
                                    <div class="listing-status-mobile <?php echo esc_attr( strtolower( $post->post_status ) ); ?>">
                                        <span><?php esc_html_e( 'Status:', 'rtcl-job-manager' ); ?></span>
                                        <span><?php echo esc_html( Functions::get_status_i18n( $post->post_status ) ); ?></span>
                                    </div>
                                </div>
                                <span class="rtcl-my-listings-table-toggle-info">
								<span class="rtcl-icon rtcl-icon-angle-down"></span>
							</span>
								<?php do_action( 'rtcl_listing_loop_extra_meta', $listing ); ?>
                            </td>

                            <td class="price-cell list-on-responsive" data-column="<?php esc_html_e( 'Information:', 'rtcl-job-manager' ); ?>">
                                <ul>
                                    <li>
										<span class="label"><strong><?php echo esc_html__( 'Application Id', 'rtcl-job-manager' ); ?>: </strong>
										<?php echo esc_html( $app_id ); ?>
                                    </li>
									<?php
									if ( $created_at ) {
										?>
                                        <li><span class="label"><strong><?php echo esc_html__( 'Application Date', 'rtcl-job-manager' ); ?>: </strong></span>
											<?php echo date_i18n( get_option( 'date_format' ), $created_at ); ?>
                                        </li>
										<?php
									}

									$salary = $listing->get_price_html();
									if ( $salary ) {
										?>
                                        <li><span class="label"><strong><?php echo esc_html__( 'Salary', 'rtcl-job-manager' ); ?>: </strong></span><?php Functions::print_html( $listing->get_price_html() ); ?></li>
										<?php
									}


									?>
                                </ul>
                            </td>
                            <td class="status-cell list-on-responsive" data-column="<?php esc_html_e( 'Status:', 'rtcl-job-manager' ); ?>">
								<?php if ( $job_status ) : ?>
                                    <span class="rtclJobStatusLabel <?php echo esc_attr( strtolower( $job_status ) ); ?>" data-id="19"><?php echo esc_html( $job_status ); ?></span>
								<?php endif; ?>
                            </td>
                        </tr>
					<?php endwhile; ?>
					<?php wp_reset_postdata(); ?>
                    </tbody>
                </table>

                <!-- pagination here -->
				<?php Pagination::pagination( $rtcl_query, true ); ?>
			<?php else : ?>
                <p class="rtcl-no-data-found"><?php esc_html_e( 'No Application found.', 'rtcl-job-manager' ); ?></p>
			<?php endif; ?>

			<?php
			do_action( 'rtcl_my_account_after_my_listing', $rtcl_query );
		}
		?>
    </div>
</div>